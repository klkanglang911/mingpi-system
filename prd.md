# 命批系统 (Mingpi System) - 产品需求文档

**文档版本：** v1.0
**最后更新：** 2025-01-01
**项目名称：** 命批系统 (MingPi System)
**项目描述：** 个性化农历月批服务系统，为用户提供基于农历的命理批示内容

---

## 目录

1. [产品概述](#1-产品概述)
2. [用户角色与权限](#2-用户角色与权限)
3. [功能模块详解](#3-功能模块详解)
4. [前端页面设计](#4-前端页面设计)
5. [后端API接口](#5-后端api接口)
6. [数据库设计](#6-数据库设计)
7. [核心业务逻辑](#7-核心业务逻辑)
8. [安全设计](#8-安全设计)
9. [部署与运维](#9-部署与运维)

---

## 1. 产品概述

### 1.1 产品定位

命批系统是一个面向传统文化爱好者的个性化农历月批服务平台。管理员可为每位用户配置专属的农历月度命批内容，用户登录后可查看自己的命批及农历日历。

### 1.2 目标用户

- **普通用户**：相信传统农历文化，希望获取个性化命批内容的用户
- **管理员**：负责用户管理和命批内容维护的运营人员

### 1.3 技术架构

```
┌─────────────────────────────────────────────────────┐
│          前端层 (原生 HTML/CSS/JS)                  │
│  登录页 | 主页面（农历日历） | 修改密码 | 管理后台  │
└─────────────────────────────────────────────────────┘
                        ↓ HTTP/JSON
┌─────────────────────────────────────────────────────┐
│          API层 (Express.js)                         │
│  认证路由 | 命批路由 | 管理路由                     │
│  中间件：JWT认证、管理员权限                        │
└─────────────────────────────────────────────────────┘
                        ↓ SQL
┌─────────────────────────────────────────────────────┐
│          数据层 (SQLite + sql.js)                   │
│  用户表 | 命批表 | 访问日志表                       │
└─────────────────────────────────────────────────────┘
```

### 1.4 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| 后端 | Node.js + Express | Web服务框架 |
| 数据库 | SQLite (sql.js) | 轻量级文件数据库 |
| 认证 | JWT (jsonwebtoken) | 无状态身份验证 |
| 密码 | bcryptjs | 密码哈希加密 |
| 前端 | 原生 HTML/CSS/JS | 无框架依赖 |
| 部署 | Docker | 容器化部署 |

---

## 2. 用户角色与权限

### 2.1 角色定义

#### 普通用户 (User)

| 权限 | 说明 |
|------|------|
| 登录/登出 | 使用用户名密码登录系统 |
| 查看农历日历 | 浏览1900-2100年农历日历 |
| 查看命批内容 | 查看管理员配置的个人命批 |
| 修改密码 | 修改自己的登录密码 |

#### 管理员 (Admin)

| 权限 | 说明 |
|------|------|
| 全部用户权限 | 拥有普通用户的所有功能 |
| 用户管理 | 创建、编辑、删除、锁定用户 |
| 命批管理 | 创建、编辑、删除、批量导入命批 |
| 数据统计 | 查看访问统计、用户活跃度等 |

### 2.2 权限矩阵

```
系统权限
├── 认证权限（所有用户）
│   ├── 登录
│   ├── 登出
│   └── 修改密码
├── 用户权限（已认证用户）
│   ├── 查看农历日历
│   └── 查看命批内容
└── 管理权限（仅管理员）
    ├── 用户管理
    │   ├── 查看用户列表
    │   ├── 创建用户
    │   ├── 编辑用户
    │   ├── 锁定/解锁用户
    │   ├── 重置密码
    │   └── 删除用户
    ├── 命批管理
    │   ├── 查看命批列表
    │   ├── 创建/编辑命批
    │   ├── 删除命批
    │   ├── 批量导入
    │   ├── 批量清空
    │   └── 导出CSV
    └── 数据统计
        ├── 概览统计
        ├── 访问趋势
        ├── 用户活跃度
        ├── 设备统计
        └── 地理位置统计
```

---

## 3. 功能模块详解

### 3.1 认证模块

#### 3.1.1 用户登录

**功能描述：** 用户使用用户名和密码登录系统

**业务规则：**
- 验证用户名和密码
- 检查账户是否被锁定
- 支持"记住我"功能（30天有效期，默认24小时）
- 登录成功后更新最后登录时间
- 首次登录强制修改密码

**交互流程：**
```
1. 用户输入用户名、密码
2. 可选勾选"保持登录状态"
3. 点击登录按钮
4. 验证成功 → 获取JWT Token
5. 检查是否首次登录
   ├── 是 → 跳转修改密码页
   └── 否 → 跳转主页面
```

#### 3.1.2 修改密码

**功能描述：** 用户修改登录密码

**业务规则：**
- 密码长度：6-50位
- 首次登录时不需验证旧密码
- 主动修改时需验证旧密码
- 修改成功后清除首次登录标记

#### 3.1.3 访问日志

**功能描述：** 记录用户访问行为

**记录内容：**
- 用户ID、操作类型、访问页面
- IP地址、地理位置
- 设备类型、操作系统、浏览器
- 访问时间

### 3.2 农历日历模块

#### 3.2.1 农历计算

**功能描述：** 支持1900-2100年阳历与农历互转

**核心功能：**
- 阳历转农历（年月日、天干地支）
- 农历月份日期范围计算
- 节气识别（24节气）
- 节日识别（传统节日+公历节日）

**数据结构：**
```javascript
{
  year: number,        // 农历年
  month: number,       // 农历月 (1-12)
  day: number,         // 农历日
  isLeap: boolean,     // 是否闰月
  monthDays: number,   // 该月总天数
  yearGan: string,     // 天干（甲-癸）
  yearZhi: string,     // 地支（子-亥）
  monthName: string,   // 月份名称（正月-腊月）
  dayName: string      // 日期名称（初一-三十）
}
```

#### 3.2.2 日历展示

**功能描述：** 展示农历月份对应的日历视图

**展示内容：**
- 当前农历月份名称和干支年
- 月份对应的阳历日期范围
- 距本月结束的倒计时（当前月）
- 日期单元格显示农历日、节气、节日

**样式规则：**
- 今天：红色高亮背景
- 当前农历月日期：浅金色背景
- 过去日期：灰色半透明
- 周末：红色文字
- 节气/节日：红色文字

### 3.3 命批模块

#### 3.3.1 命批展示

**功能描述：** 展示用户当前月份的命批内容

**业务规则：**
- 根据当前农历年月查询用户命批
- 无自定义内容时显示默认励志语句
- 切换月份时同步更新命批内容

**默认命批（8条）：**
1. 岁月如流，时光荏苒，愿你珍惜当下每一天。
2. 春有百花秋有月，夏有凉风冬有雪。若无闲事挂心头，便是人间好时节。
3. 天行健，君子以自强不息；地势坤，君子以厚德载物。
4. 行到水穷处，坐看云起时。
5. 人生若只如初见，何事秋风悲画扇。
6. 山不在高，有仙则名；水不在深，有龙则灵。
7. 采菊东篱下，悠然见南山。
8. 宠辱不惊，看庭前花开花落；去留无意，望天上云卷云舒。

#### 3.3.2 命批管理（管理员）

**功能描述：** 管理员管理用户命批内容

**功能列表：**
| 功能 | 说明 |
|------|------|
| 单条编辑 | 为指定用户指定月份创建/编辑命批 |
| 批量导入 | 可视化编辑或CSV文件导入 |
| 批量清空 | 清空用户某年或全部命批 |
| 导出CSV | 导出命批数据备份 |
| 下载模板 | 下载CSV导入模板 |

**批量导入格式：**

格式A - 可视化导入（按行对应月份）：
```
正月命批内容...
二月命批内容...
...
腊月命批内容...
```

格式B - 带月份前缀（可只导入部分月份）：
```
1:正月命批内容...
5:五月命批内容...
12:腊月命批内容...
```

格式C - CSV文件：
```csv
用户名,农历年份,月份,命批内容
zhangsan,2025,1,正月命批内容...
zhangsan,2025,2,二月命批内容...
```

### 3.4 用户管理模块（管理员）

**功能列表：**

| 功能 | 说明 | 限制 |
|------|------|------|
| 查看列表 | 支持搜索用户名/显示名称 | - |
| 创建用户 | 自动生成8位随机密码 | - |
| 编辑用户 | 修改用户名、显示名称 | - |
| 锁定用户 | 锁定后无法登录 | 不能锁定自己和管理员 |
| 重置密码 | 生成新密码，强制修改 | - |
| 删除用户 | 级联删除关联命批 | 不能删除自己 |

**创建用户流程：**
```
1. 点击"创建新用户"
2. 输入用户名、显示名称
3. 系统自动生成随机密码
4. 显示密码供管理员复制
5. 告知用户使用该密码首次登录
6. 用户首次登录后强制修改密码
```

### 3.5 统计模块（管理员）

**统计指标：**

| 指标分类 | 具体指标 |
|----------|----------|
| 概览统计 | 总用户数、总命批数、今日PV、今日UV |
| 访问趋势 | 7天/30天PV和UV折线图 |
| 用户活跃度 | 今日登录、周活、月活、从未登录、已锁定 |
| 命批覆盖率 | 各年份覆盖率、用户平均覆盖月份 |
| 设备统计 | 设备类型、操作系统、浏览器分布 |
| 地理位置 | 访问来源地理分布 |
| 活动日志 | 最近操作记录列表 |

---

## 4. 前端页面设计

### 4.1 登录页 (`/index.html`)

**页面元素：**
- Logo和标题
- 用户名输入框
- 密码输入框
- "保持登录状态"复选框
- 登录按钮
- 加载进度条

**设计风格：**
- 中国传统文化美学
- 主色调：朱砂红、黑金色
- 宣纸纹理背景

### 4.2 主页面 (`/main.html`)

**页面布局：**
```
┌─────────────────────────────────────────┐
│ 标题：灵庐书院 年批月令      [退出]     │
├─────────────────────────────────────────┤
│ ·本月命批·                              │
│ [个性化命批内容]                        │
├─────────────────────────────────────────┤
│ [◀] 腊月  距本月结束还剩N天  [▶]        │
│      甲辰年                             │
├─────────────────────────────────────────┤
│ 2024年12月                              │
│ 日 一 二 三 四 五 六                    │
│ [日期网格，显示农历日、节气、节日]      │
├─────────────────────────────────────────┤
│ 人间有清醒 欢迎来灵庐                   │
└─────────────────────────────────────────┘
```

### 4.3 修改密码页 (`/change-password.html`)

**页面元素：**
- 新密码输入框
- 确认密码输入框
- 提交按钮
- 错误/成功提示

### 4.4 管理后台

#### 4.4.1 统计仪表盘 (`/admin/index.html`)

- 概览卡片（用户数、命批数、PV、UV）
- 访问趋势图表
- 用户活跃度统计
- 命批覆盖率统计
- 设备和地理位置统计
- 最近活动日志

#### 4.4.2 用户管理 (`/admin/users.html`)

- 用户列表表格
- 搜索框
- 创建用户按钮
- 操作按钮（编辑、锁定、重置密码、删除）

#### 4.4.3 命批管理 (`/admin/mingpi.html`)

- 标签页切换（批量导入 / 单条编辑）
- 用户选择器（支持搜索、创建新用户）
- 年份选择器（2025年起）
- 批量输入文本框
- 月份按钮网格（单条编辑）
- 命批列表表格

---

## 5. 后端API接口

### 5.1 认证接口 (`/api/auth`)

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| POST | /login | 用户登录 | 否 |
| POST | /logout | 用户登出 | 是 |
| POST | /change-password | 修改密码 | 是 |
| GET | /me | 获取当前用户信息 | 是 |
| POST | /visit | 记录页面访问 | 是 |

### 5.2 命批接口 (`/api/mingpi`)

| 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|
| GET | /current | 获取当前月命批 | 是 |
| GET | /:year/:month | 获取指定月命批 | 是 |

### 5.3 管理接口 (`/api/admin`)

#### 用户管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /users | 获取用户列表 |
| POST | /users | 创建用户 |
| PUT | /users/:id | 编辑用户 |
| DELETE | /users/:id | 删除用户 |
| POST | /users/:id/lock | 锁定/解锁用户 |
| POST | /users/:id/reset-password | 重置密码 |

#### 命批管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /mingpi | 获取命批列表 |
| GET | /mingpi/user/:userId | 获取用户命批 |
| POST | /mingpi | 创建/更新命批 |
| DELETE | /mingpi/:id | 删除命批 |
| POST | /mingpi/batch | 批量导入 |
| POST | /mingpi/batch/preview | 预览导入 |
| DELETE | /mingpi/batch | 批量清空 |
| GET | /mingpi/export | 导出CSV |
| GET | /mingpi/template | 下载模板 |

#### 统计接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /stats/overview | 概览统计 |
| GET | /stats/trend | 访问趋势 |
| GET | /stats/users | 用户活跃度 |
| GET | /stats/mingpi | 命批覆盖率 |
| GET | /stats/devices | 设备统计 |
| GET | /stats/locations | 地理位置统计 |
| GET | /stats/logs | 活动日志 |

---

## 6. 数据库设计

### 6.1 用户表 (users)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| username | VARCHAR(50) | 用户名，唯一 |
| password_hash | VARCHAR(255) | bcrypt密码哈希 |
| display_name | VARCHAR(100) | 显示名称 |
| is_admin | INTEGER | 是否管理员 (0/1) |
| is_locked | INTEGER | 是否锁定 (0/1) |
| must_change_password | INTEGER | 是否需修改密码 (0/1) |
| created_at | DATETIME | 创建时间 |
| last_login_at | DATETIME | 最后登录时间 |

### 6.2 命批表 (mingpi)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| user_id | INTEGER | 用户ID，外键 |
| lunar_year | INTEGER | 农历年 (1900-2100) |
| lunar_month | INTEGER | 农历月 (1-12) |
| content | TEXT | 命批内容 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**约束：**
- UNIQUE(user_id, lunar_year, lunar_month)
- FOREIGN KEY(user_id) → users(id) ON DELETE CASCADE

### 6.3 访问日志表 (access_logs)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| user_id | INTEGER | 用户ID |
| action | VARCHAR(50) | 操作类型 |
| page | VARCHAR(100) | 访问页面 |
| ip_address | VARCHAR(50) | IP地址 |
| location | VARCHAR(100) | 地理位置 |
| device_type | VARCHAR(20) | 设备类型 |
| os | VARCHAR(50) | 操作系统 |
| browser | VARCHAR(50) | 浏览器 |
| user_agent | VARCHAR(500) | UA字符串 |
| extra_data | TEXT | JSON额外数据 |
| created_at | DATETIME | 创建时间 |

**操作类型：**
- 用户操作：login, logout, view_calendar, view_mingpi, change_password
- 管理操作：admin_login, admin_create_user, admin_edit_user, admin_delete_user, admin_lock_user, admin_reset_password, admin_create_mingpi, admin_edit_mingpi, admin_delete_mingpi, admin_batch_import, admin_batch_delete

---

## 7. 核心业务逻辑

### 7.1 认证流程

```
登录流程：
1. 验证用户名密码 (bcrypt.compare)
2. 检查账户锁定状态
3. 生成JWT Token (24h/30d)
4. 更新last_login_at
5. 记录登录日志
6. 返回token和用户信息

Token验证流程：
1. 从Authorization头提取token
2. 验证token签名和有效期
3. 查询用户是否存在
4. 检查用户是否被锁定
5. 允许/拒绝请求
```

### 7.2 密码管理

**密码生成规则：**
- 长度：8位
- 包含：小写字母、大写字母、数字
- 排除易混淆字符：l, o, I, O, 0, 1

**密码哈希：**
- 算法：bcryptjs
- Salt Rounds：10

### 7.3 命批UPSERT逻辑

```
创建/更新命批：
1. 检查(user_id, lunar_year, lunar_month)是否存在
2. 存在 → UPDATE content, updated_at
3. 不存在 → INSERT新记录
4. 返回操作类型 (created/updated)
```

### 7.4 IP地理位置查询

- 服务：ip-api.com（免费）
- 缓存：24小时TTL，最大1000条
- 跳过：本地IP (127.0.0.1, 192.168.x.x, 10.x.x.x)
- 异步：不阻塞主流程

---

## 8. 安全设计

### 8.1 身份验证

- JWT Token认证（无状态）
- Token有效期：24小时或30天
- 密码bcrypt加密存储

### 8.2 权限控制

- 中间件级别权限验证
- 管理员接口独立中间件
- 操作审计日志记录

### 8.3 数据保护

- 参数化SQL查询（防注入）
- 启用CORS
- 禁止缓存敏感接口

### 8.4 账户安全

- 首次登录强制改密
- 账户锁定机制
- 密码强度验证

---

## 9. 部署与运维

### 9.1 环境变量

```
PORT=3000                          # 服务端口
JWT_SECRET=change-this-secret      # JWT密钥（必须修改）
DATABASE_PATH=../data/mingpi.db    # 数据库路径
NODE_ENV=production                # 环境标志
ADMIN_USERNAME=admin               # 管理员用户名
ADMIN_PASSWORD=admin123            # 管理员初始密码
```

### 9.2 部署命令

**本地开发：**
```bash
cd server
npm install
npm run dev
```

**Docker部署：**
```bash
cd docker
docker-compose up -d
# 访问：http://localhost:666
```

### 9.3 数据备份

```bash
# Docker环境
docker cp mingpi-system:/app/data/mingpi.db ./backup/

# 本地环境
cp data/mingpi.db ./backup/
```

### 9.4 默认账户

- 用户名：admin
- 密码：admin123
- 首次登录需修改密码

---

## 附录

### A. 农历月份名称对照

| 月份 | 名称 |
|------|------|
| 1 | 正月 |
| 2 | 二月 |
| 3 | 三月 |
| 4 | 四月 |
| 5 | 五月 |
| 6 | 六月 |
| 7 | 七月 |
| 8 | 八月 |
| 9 | 九月 |
| 10 | 十月 |
| 11 | 冬月 |
| 12 | 腊月 |

### B. 支持的节日

**农历节日：**
春节、元宵、端午、七夕、中元、中秋、重阳、腊八、小年、除夕

**公历节日：**
元旦、情人节、妇女节、愚人节、劳动节、青年节、儿童节、国庆节、圣诞节

### C. 24节气

小寒、大寒、立春、雨水、惊蛰、春分、清明、谷雨、立夏、小满、芒种、夏至、小暑、大暑、立秋、处暑、白露、秋分、寒露、霜降、立冬、小雪、大雪、冬至
