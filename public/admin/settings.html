<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿè®¾ç½® - ç®¡ç†åå°</title>
    <style>
        :root {
            --ink-black: #1a1a1a;
            --ink-light: #4a4a4a;
            --vermilion: #c23a2b;
            --gold-accent: #b8860b;
            --paper-white: #f8f5f0;
            --paper-cream: #f0ebe3;
            --mist-gray: #9a9590;
            --border-light: rgba(26, 26, 26, 0.1);
            --success: #2e7d32;
            --danger: #c62828;
            --info: #1976d2;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--paper-cream);
            color: var(--ink-black);
            min-height: 100vh;
        }

        .header {
            background: var(--ink-black);
            color: var(--paper-white);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 { font-size: 1.25rem; font-weight: 500; }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-right span { font-size: 0.875rem; }
        .header-right a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.875rem; }
        .header-right a:hover { color: var(--paper-white); }

        .nav {
            background: var(--paper-white);
            border-bottom: 1px solid var(--border-light);
            padding: 0 2rem;
        }

        .nav ul { list-style: none; display: flex; gap: 2rem; }

        .nav a {
            display: block;
            padding: 1rem 0;
            color: var(--ink-light);
            text-decoration: none;
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav a:hover, .nav a.active {
            color: var(--vermilion);
            border-color: var(--vermilion);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .panel {
            background: var(--paper-white);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }

        .panel-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            font-size: 1rem;
            font-weight: 500;
        }

        .panel-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--ink-black);
        }

        .form-group .hint {
            font-size: 0.8rem;
            color: var(--mist-gray);
            margin-top: 0.5rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--gold-accent);
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
        }

        .input-group input {
            flex: 1;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--ink-black);
            color: var(--paper-white);
        }

        .btn-primary:hover { background: var(--ink-light); }

        .btn-secondary {
            background: var(--paper-cream);
            color: var(--ink-black);
            border: 1px solid var(--border-light);
        }

        .btn-secondary:hover { background: var(--paper-white); border-color: var(--mist-gray); }

        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger:hover, .btn-success:hover, .btn-warning:hover { opacity: 0.9; }

        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.875rem;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: toastSlideIn 0.3s ease-out;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .alert-success { background: #2e7d32; color: white; }
        .alert-error { background: #c62828; color: white; }
        .alert-warning { background: #f59e0b; color: white; }
        .alert-info { background: #1976d2; color: white; }

        .current-path {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--paper-cream);
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .current-path-label {
            font-size: 0.875rem;
            color: var(--mist-gray);
        }

        .current-path-value {
            font-family: monospace;
            font-size: 1rem;
            font-weight: 600;
            color: var(--vermilion);
            flex: 1;
        }

        .copy-btn {
            padding: 0.5rem;
            background: none;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--paper-white);
            border-color: var(--gold-accent);
        }

        .copy-btn.copied {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .security-note {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 4px;
            border-left: 3px solid var(--warning);
            margin-bottom: 1rem;
        }

        .security-note-icon {
            font-size: 1.25rem;
        }

        .security-note-text {
            font-size: 0.875rem;
            color: var(--ink-light);
            line-height: 1.5;
        }

        .divider {
            height: 1px;
            background: var(--border-light);
            margin: 1.5rem 0;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-info h3 {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .setting-info p {
            font-size: 0.8rem;
            color: var(--mist-gray);
        }

        .setting-value {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .setting-value input {
            width: 80px;
            padding: 0.5rem;
            text-align: center;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .setting-value span {
            font-size: 0.875rem;
            color: var(--mist-gray);
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>å‘½æ‰¹ç³»ç»Ÿ - ç®¡ç†åå°</h1>
        <div class="header-right">
            <span id="adminName">ç®¡ç†å‘˜</span>
            <a href="/" id="logoutBtn">é€€å‡º</a>
        </div>
    </header>

    <nav class="nav">
        <ul id="navMenu">
            <li><a href="/admin/">é¦–é¡µ</a></li>
            <li><a href="/admin/users.html">ç”¨æˆ·ç®¡ç†</a></li>
            <li><a href="/admin/mingpi.html">å‘½æ‰¹ç®¡ç†</a></li>
            <li><a href="/admin/settings.html" class="active">ç³»ç»Ÿè®¾ç½®</a></li>
        </ul>
    </nav>

    <div class="container">
        <div id="alertBox"></div>

        <!-- åå°è·¯å¾„è®¾ç½® -->
        <div class="panel">
            <div class="panel-header">
                <h2>åå°è·¯å¾„è®¾ç½®</h2>
            </div>
            <div class="panel-body">
                <div class="security-note">
                    <span class="security-note-icon">âš ï¸</span>
                    <div class="security-note-text">
                        <strong>å®‰å…¨æç¤ºï¼š</strong>ä¿®æ”¹åå°è·¯å¾„åï¼Œå½“å‰é¡µé¢é“¾æ¥å°†å¤±æ•ˆã€‚è¯·åŠ¡å¿…è®°ä½æ–°è·¯å¾„ï¼Œæˆ–æå‰å¤åˆ¶å®Œæ•´è®¿é—®åœ°å€ã€‚
                    </div>
                </div>

                <div class="current-path">
                    <span class="current-path-label">å½“å‰åå°åœ°å€ï¼š</span>
                    <span class="current-path-value" id="currentFullPath">åŠ è½½ä¸­...</span>
                    <button class="copy-btn" id="copyPathBtn" onclick="copyCurrentPath()">å¤åˆ¶</button>
                </div>

                <div class="form-group">
                    <label>åå°è·¯å¾„</label>
                    <div class="input-group">
                        <input type="text" id="adminPathInput" placeholder="è¾“å…¥æ–°è·¯å¾„ï¼ˆ4-32ä½å­—æ¯æ•°å­—ï¼‰">
                        <button class="btn btn-secondary" onclick="regeneratePath()">éšæœºç”Ÿæˆ</button>
                    </div>
                    <p class="hint">åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­åˆ’çº¿ï¼Œé•¿åº¦4-32ä½ã€‚é¿å…ä½¿ç”¨ adminã€api ç­‰å¸¸è§åç§°ã€‚</p>
                </div>

                <button class="btn btn-warning" onclick="saveAdminPath()">ä¿å­˜å¹¶è·³è½¬åˆ°æ–°è·¯å¾„</button>
            </div>
        </div>

        <!-- ç™»å½•å®‰å…¨è®¾ç½® -->
        <div class="panel">
            <div class="panel-header">
                <h2>ç™»å½•å®‰å…¨è®¾ç½®</h2>
            </div>
            <div class="panel-body">
                <div class="setting-row">
                    <div class="setting-info">
                        <h3>æœ€å¤§ç™»å½•å¤±è´¥æ¬¡æ•°</h3>
                        <p>è¶…è¿‡æ­¤æ¬¡æ•°åè´¦æˆ·å°†è¢«ä¸´æ—¶é”å®š</p>
                    </div>
                    <div class="setting-value">
                        <input type="number" id="maxAttemptsInput" min="3" max="10" value="5">
                        <span>æ¬¡</span>
                    </div>
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <h3>é”å®šæ—¶é—´</h3>
                        <p>è´¦æˆ·é”å®šåéœ€ç­‰å¾…çš„æ—¶é—´</p>
                    </div>
                    <div class="setting-value">
                        <input type="number" id="lockMinutesInput" min="5" max="60" value="15">
                        <span>åˆ†é’Ÿ</span>
                    </div>
                </div>

                <div class="divider"></div>

                <button class="btn btn-primary" onclick="saveSecuritySettings()">ä¿å­˜å®‰å…¨è®¾ç½®</button>
            </div>
        </div>

        <!-- å¹´æ‰¹å¼€å¯æ—¶é—´è®¾ç½® -->
        <div class="panel">
            <div class="panel-header">
                <h2>å¹´æ‰¹å¼€å¯æ—¶é—´è®¾ç½®</h2>
            </div>
            <div class="panel-body">
                <div class="security-note" style="background: rgba(25, 118, 210, 0.1); border-left-color: var(--info);">
                    <span class="security-note-icon">ğŸ’¡</span>
                    <div class="security-note-text">
                        <strong>åŠŸèƒ½è¯´æ˜ï¼š</strong>è®¾ç½®å¹´æ‰¹å¼€å¯æ—¶é—´åï¼Œç”¨æˆ·åœ¨å¼€å¯æ—¶é—´ä¹‹å‰å°†çœ‹åˆ°è’™ç‰ˆé®ç½©ï¼Œæ— æ³•æŸ¥çœ‹å‘½æ‰¹å†…å®¹ã€‚æ—¶é—´åˆ°è¾¾åè’™ç‰ˆè‡ªåŠ¨æ¶ˆå¤±ã€‚ç•™ç©ºåˆ™ä¸å¯ç”¨è’™ç‰ˆã€‚
                    </div>
                </div>

                <div class="form-group">
                    <label>å¼€å¯æ—¶é—´</label>
                    <input type="datetime-local" id="openingTimeInput" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-light); border-radius: 4px; font-size: 0.9rem;">
                    <p class="hint">è®¾ç½®å‘½æ‰¹å†…å®¹å¼€æ”¾çš„å…·ä½“æ—¥æœŸå’Œæ—¶é—´ï¼Œç•™ç©ºè¡¨ç¤ºç«‹å³å¼€æ”¾</p>
                </div>

                <div class="form-group">
                    <label>è’™ç‰ˆä¸»æ–‡æ¡ˆ</label>
                    <input type="text" id="openingTextInput" placeholder="å°å¯’å¼€å¯ä½ çš„æ–°ä¸€å¹´å‘½æ‰¹">
                    <p class="hint">æ˜¾ç¤ºåœ¨è’™ç‰ˆä¸­å¤®çš„ä¸»è¦æç¤ºæ–‡å­—ï¼Œå¦‚"å°å¯’å¼€å¯ä½ çš„æ–°ä¸€å¹´å‘½æ‰¹"</p>
                </div>

                <div class="form-group">
                    <label>è’™ç‰ˆå‰¯æ–‡æ¡ˆ</label>
                    <input type="text" id="openingSubtextInput" placeholder="æ•¬è¯·æœŸå¾… Â· é™å€™å¤©æ—¶">
                    <p class="hint">æ˜¾ç¤ºåœ¨ä¸»æ–‡æ¡ˆä¸‹æ–¹çš„è¾…åŠ©è¯´æ˜æ–‡å­—</p>
                </div>

                <div class="divider"></div>

                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="saveOpeningSettings()">ä¿å­˜å¼€å¯è®¾ç½®</button>
                    <button class="btn btn-secondary" onclick="clearOpeningTime()">æ¸…ç©ºå¼€å¯æ—¶é—´</button>
                    <button class="btn btn-secondary" onclick="previewOverlay()">é¢„è§ˆè’™ç‰ˆæ•ˆæœ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || !user.isAdmin) {
            window.location.href = '/';
        }

        document.getElementById('adminName').textContent = user.displayName || 'ç®¡ç†å‘˜';

        // æ›´æ–°å¯¼èˆªé“¾æ¥ä¸ºå½“å‰åå°è·¯å¾„ï¼ˆç«‹å³æ‰§è¡Œï¼‰
        (function initNavLinks() {
            const currentPath = window.location.pathname;
            const pathParts = currentPath.split('/').filter(p => p);
            if (pathParts.length > 0) {
                const urlAdminPath = pathParts[0];
                document.querySelectorAll('#navMenu a').forEach(link => {
                    const href = link.getAttribute('href');
                    if (href.startsWith('/admin')) {
                        link.setAttribute('href', href.replace('/admin', '/' + urlAdminPath));
                    }
                });
            }
        })();

        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        });

        let currentAdminPath = '';

        function showAlert(message, type = 'success') {
            const alertBox = document.getElementById('alertBox');
            alertBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            if (type !== 'error') {
                setTimeout(() => { alertBox.innerHTML = ''; }, 5000);
            }
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('/api/admin/config', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const result = await response.json();
                    const data = result.data;

                    // åå°è·¯å¾„
                    currentAdminPath = data.admin_path?.value || 'admin';
                    document.getElementById('adminPathInput').value = currentAdminPath;
                    document.getElementById('currentFullPath').textContent =
                        window.location.origin + '/' + currentAdminPath;

                    // å®‰å…¨è®¾ç½®
                    document.getElementById('maxAttemptsInput').value = data.login_max_attempts?.value || '5';
                    document.getElementById('lockMinutesInput').value = data.login_lock_minutes?.value || '15';

                    // å¹´æ‰¹å¼€å¯æ—¶é—´è®¾ç½®
                    const openingTime = data.yearly_opening_time?.value || '';
                    if (openingTime) {
                        // è½¬æ¢ä¸º datetime-local æ ¼å¼ (YYYY-MM-DDTHH:mm)
                        const date = new Date(openingTime);
                        if (!isNaN(date.getTime())) {
                            const localDateTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000)
                                .toISOString().slice(0, 16);
                            document.getElementById('openingTimeInput').value = localDateTime;
                        }
                    }
                    document.getElementById('openingTextInput').value = data.yearly_opening_text?.value || '';
                    document.getElementById('openingSubtextInput').value = data.yearly_opening_subtext?.value || '';
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                showAlert('åŠ è½½é…ç½®å¤±è´¥', 'error');
            }
        }

        // å¤åˆ¶å½“å‰è·¯å¾„
        async function copyCurrentPath() {
            const fullPath = document.getElementById('currentFullPath').textContent;
            try {
                await navigator.clipboard.writeText(fullPath);
                const btn = document.getElementById('copyPathBtn');
                btn.textContent = 'å·²å¤åˆ¶';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'å¤åˆ¶';
                    btn.classList.remove('copied');
                }, 2000);
            } catch (error) {
                // é™çº§æ–¹æ¡ˆ
                const textarea = document.createElement('textarea');
                textarea.value = fullPath;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);

                const btn = document.getElementById('copyPathBtn');
                btn.textContent = 'å·²å¤åˆ¶';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'å¤åˆ¶';
                    btn.classList.remove('copied');
                }, 2000);
            }
        }

        // éšæœºç”Ÿæˆè·¯å¾„
        async function regeneratePath() {
            try {
                const response = await fetch('/api/admin/config/regenerate-path', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('adminPathInput').value = result.data.adminPath;
                    showAlert('å·²ç”Ÿæˆæ–°è·¯å¾„ï¼Œè¯·ç‚¹å‡»"ä¿å­˜"æŒ‰é’®åº”ç”¨æ›´æ”¹');
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'ç”Ÿæˆå¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // ä¿å­˜åå°è·¯å¾„
        async function saveAdminPath() {
            const newPath = document.getElementById('adminPathInput').value.trim();

            if (!newPath) {
                showAlert('è¯·è¾“å…¥åå°è·¯å¾„', 'error');
                return;
            }

            // éªŒè¯æ ¼å¼
            if (!/^[a-zA-Z0-9_-]+$/.test(newPath)) {
                showAlert('è·¯å¾„åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­åˆ’çº¿', 'error');
                return;
            }

            if (newPath.length < 4 || newPath.length > 32) {
                showAlert('è·¯å¾„é•¿åº¦éœ€åœ¨4-32ä½ä¹‹é—´', 'error');
                return;
            }

            // ç¡®è®¤æç¤º
            if (!confirm(`ç¡®å®šè¦å°†åå°è·¯å¾„ä¿®æ”¹ä¸º "${newPath}" å—ï¼Ÿ\n\nä¿®æ”¹åå½“å‰é¡µé¢å°†å¤±æ•ˆï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è·³è½¬åˆ°æ–°åœ°å€ã€‚`)) {
                return;
            }

            try {
                const response = await fetch('/api/admin/config/admin_path', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ value: newPath })
                });

                if (response.ok) {
                    showAlert('è·¯å¾„å·²æ›´æ–°ï¼Œæ­£åœ¨è·³è½¬...', 'success');
                    // è·³è½¬åˆ°æ–°è·¯å¾„
                    setTimeout(() => {
                        window.location.href = '/' + newPath + '/settings.html';
                    }, 1500);
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // ä¿å­˜å®‰å…¨è®¾ç½®
        async function saveSecuritySettings() {
            const maxAttempts = parseInt(document.getElementById('maxAttemptsInput').value);
            const lockMinutes = parseInt(document.getElementById('lockMinutesInput').value);

            if (maxAttempts < 3 || maxAttempts > 10) {
                showAlert('æœ€å¤§å¤±è´¥æ¬¡æ•°éœ€åœ¨3-10ä¹‹é—´', 'error');
                return;
            }

            if (lockMinutes < 5 || lockMinutes > 60) {
                showAlert('é”å®šæ—¶é—´éœ€åœ¨5-60åˆ†é’Ÿä¹‹é—´', 'error');
                return;
            }

            try {
                // ä¿å­˜æœ€å¤§å¤±è´¥æ¬¡æ•°
                await fetch('/api/admin/config/login_max_attempts', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ value: maxAttempts.toString() })
                });

                // ä¿å­˜é”å®šæ—¶é—´
                await fetch('/api/admin/config/login_lock_minutes', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ value: lockMinutes.toString() })
                });

                showAlert('å®‰å…¨è®¾ç½®å·²ä¿å­˜');
            } catch (error) {
                showAlert('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // ä¿å­˜å¹´æ‰¹å¼€å¯è®¾ç½®
        async function saveOpeningSettings() {
            const openingTime = document.getElementById('openingTimeInput').value;
            const openingText = document.getElementById('openingTextInput').value.trim();
            const openingSubtext = document.getElementById('openingSubtextInput').value.trim();

            try {
                // ä¿å­˜å¼€å¯æ—¶é—´ï¼ˆè½¬æ¢ä¸º ISO æ ¼å¼ï¼‰
                let isoTime = '';
                if (openingTime) {
                    isoTime = new Date(openingTime).toISOString();
                }

                await fetch('/api/admin/config/yearly_opening_time', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ value: isoTime })
                });

                // ä¿å­˜ä¸»æ–‡æ¡ˆ
                if (openingText) {
                    await fetch('/api/admin/config/yearly_opening_text', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ value: openingText })
                    });
                }

                // ä¿å­˜å‰¯æ–‡æ¡ˆ
                if (openingSubtext) {
                    await fetch('/api/admin/config/yearly_opening_subtext', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ value: openingSubtext })
                    });
                }

                showAlert('å¹´æ‰¹å¼€å¯è®¾ç½®å·²ä¿å­˜');
            } catch (error) {
                showAlert('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // æ¸…ç©ºå¼€å¯æ—¶é—´
        async function clearOpeningTime() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºå¼€å¯æ—¶é—´å—ï¼Ÿæ¸…ç©ºåè’™ç‰ˆå°†ä¸å†æ˜¾ç¤ºã€‚')) {
                return;
            }

            try {
                await fetch('/api/admin/config/yearly_opening_time', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ value: '' })
                });

                document.getElementById('openingTimeInput').value = '';
                showAlert('å¼€å¯æ—¶é—´å·²æ¸…ç©º');
            } catch (error) {
                showAlert('æ¸…ç©ºå¤±è´¥', 'error');
            }
        }

        // é¢„è§ˆè’™ç‰ˆæ•ˆæœ
        function previewOverlay() {
            const openingTime = document.getElementById('openingTimeInput').value;
            const openingText = document.getElementById('openingTextInput').value.trim() || 'å°å¯’å¼€å¯ä½ çš„æ–°ä¸€å¹´å‘½æ‰¹';
            const openingSubtext = document.getElementById('openingSubtextInput').value.trim() || 'æ•¬è¯·æœŸå¾… Â· é™å€™å¤©æ—¶';

            // è®¡ç®—å€’è®¡æ—¶
            let countdown = { days: 0, hours: 0, minutes: 0, seconds: 0 };
            if (openingTime) {
                const target = new Date(openingTime);
                const now = new Date();
                let diff = Math.max(0, target - now);

                countdown.days = Math.floor(diff / (1000 * 60 * 60 * 24));
                diff -= countdown.days * (1000 * 60 * 60 * 24);
                countdown.hours = Math.floor(diff / (1000 * 60 * 60));
                diff -= countdown.hours * (1000 * 60 * 60);
                countdown.minutes = Math.floor(diff / (1000 * 60));
                diff -= countdown.minutes * (1000 * 60);
                countdown.seconds = Math.floor(diff / 1000);
            }

            // æ ¼å¼åŒ–å¼€å¯æ—¶é—´æ˜¾ç¤º
            let openTimeDisplay = '';
            if (openingTime) {
                const date = new Date(openingTime);
                openTimeDisplay = date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            // åˆ›å»ºé¢„è§ˆçª—å£ï¼ˆæ¨¡æ‹Ÿæ‰‹æœºç«–å±ï¼‰
            const previewWindow = window.open('', '_blank', 'width=390,height=700');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html lang="zh-CN">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>è’™ç‰ˆé¢„è§ˆ - æ‰‹æœºç«–å±æ•ˆæœ</title>
                    <style>
                        :root {
                            --vermilion: #c23a2b;
                            --gold-accent: #b8860b;
                            --ink-black: #1a1a1a;
                            --mist-gray: #9a9590;
                            --paper-cream: #efe9e0;
                            --paper-white: #f8f5f0;
                        }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
                            background: var(--paper-cream);
                            min-height: 100vh;
                        }
                        .overlay {
                            position: fixed;
                            top: 0; left: 0; right: 0; bottom: 0;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            overflow: hidden;
                        }
                        .overlay-backdrop {
                            position: absolute;
                            inset: 0;
                            background: rgba(248, 245, 240, 0.75);
                            backdrop-filter: blur(12px);
                            -webkit-backdrop-filter: blur(12px);
                        }
                        .overlay-texture {
                            position: absolute;
                            inset: 0;
                            background:
                                radial-gradient(ellipse at 20% 20%, rgba(194, 58, 43, 0.03) 0%, transparent 50%),
                                radial-gradient(ellipse at 80% 80%, rgba(184, 134, 11, 0.03) 0%, transparent 40%);
                            pointer-events: none;
                        }
                        .seal-frame {
                            position: relative;
                            z-index: 10;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            width: 85%;
                            max-width: 320px;
                            padding: 2.5rem 2rem;
                            background: var(--paper-white);
                            border-radius: 4px;
                            box-shadow:
                                0 20px 60px rgba(26, 26, 26, 0.15),
                                0 8px 25px rgba(26, 26, 26, 0.1),
                                0 0 0 1px rgba(194, 58, 43, 0.1);
                            animation: cardFloat 4s ease-in-out infinite;
                        }
                        @keyframes cardFloat {
                            0%, 100% { transform: translateY(0); }
                            50% { transform: translateY(-8px); }
                        }
                        .seal-frame::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 50%;
                            transform: translateX(-50%);
                            width: 60px;
                            height: 3px;
                            background: linear-gradient(90deg, transparent, var(--vermilion), transparent);
                            border-radius: 0 0 2px 2px;
                        }
                        .seal-container {
                            position: relative;
                            border: 2px solid var(--vermilion);
                            padding: 1.5rem 1.75rem;
                            margin-bottom: 1.5rem;
                            animation: sealGlow 3s ease-in-out infinite;
                        }
                        @keyframes sealGlow {
                            0%, 100% { box-shadow: 0 0 0 1px rgba(194, 58, 43, 0.15), 0 0 20px rgba(194, 58, 43, 0.05); }
                            50% { box-shadow: 0 0 0 1px rgba(194, 58, 43, 0.3), 0 0 30px rgba(194, 58, 43, 0.1); }
                        }
                        .seal-corner {
                            position: absolute;
                            width: 14px;
                            height: 14px;
                            border: 2px solid var(--vermilion);
                            opacity: 0.7;
                        }
                        .seal-corner.top-left { top: -3px; left: -3px; border-right: none; border-bottom: none; }
                        .seal-corner.top-right { top: -3px; right: -3px; border-left: none; border-bottom: none; }
                        .seal-corner.bottom-left { bottom: -3px; left: -3px; border-right: none; border-top: none; }
                        .seal-corner.bottom-right { bottom: -3px; right: -3px; border-left: none; border-top: none; }
                        .solar-term-icon {
                            font-size: 2rem;
                            color: var(--gold-accent);
                            margin-bottom: 0.75rem;
                            text-shadow: 0 2px 8px rgba(184, 134, 11, 0.3);
                            animation: iconPulse 2s ease-in-out infinite;
                        }
                        @keyframes iconPulse {
                            0%, 100% { opacity: 0.8; transform: scale(1); }
                            50% { opacity: 1; transform: scale(1.08); }
                        }
                        .seal-text {
                            font-size: 1.25rem;
                            font-weight: 500;
                            color: var(--ink-black);
                            text-align: center;
                            letter-spacing: 0.15em;
                            line-height: 1.6;
                        }
                        .seal-text .highlight {
                            color: var(--vermilion);
                            font-weight: 600;
                        }
                        .seal-subtext {
                            font-size: 0.8rem;
                            color: var(--mist-gray);
                            margin-top: 0.75rem;
                            letter-spacing: 0.1em;
                        }
                        .countdown-section {
                            width: 100%;
                            text-align: center;
                        }
                        .countdown-label {
                            font-size: 0.75rem;
                            color: var(--mist-gray);
                            letter-spacing: 0.15em;
                            margin-bottom: 1rem;
                        }
                        .countdown-display {
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 0.5rem;
                        }
                        .countdown-unit {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            min-width: 42px;
                            padding: 0.5rem 0.25rem;
                            background: var(--paper-cream);
                            border-radius: 4px;
                        }
                        .countdown-value {
                            font-size: 1.5rem;
                            font-weight: 700;
                            color: var(--vermilion);
                            line-height: 1;
                        }
                        .countdown-name {
                            font-size: 0.65rem;
                            color: var(--mist-gray);
                            margin-top: 0.25rem;
                        }
                        .countdown-separator {
                            font-size: 1.25rem;
                            color: var(--gold-accent);
                            opacity: 0.6;
                        }
                        .overlay-footer {
                            position: absolute;
                            bottom: 2rem;
                            left: 0;
                            right: 0;
                            text-align: center;
                            font-size: 0.7rem;
                            color: var(--mist-gray);
                            letter-spacing: 0.2em;
                            opacity: 0.6;
                        }
                    </style>
                </head>
                <body>
                    <div class="overlay">
                        <div class="overlay-backdrop"></div>
                        <div class="overlay-texture"></div>
                        <div class="seal-frame">
                            <div class="seal-container">
                                <div class="seal-corner top-left"></div>
                                <div class="seal-corner top-right"></div>
                                <div class="seal-corner bottom-left"></div>
                                <div class="seal-corner bottom-right"></div>
                                <div class="solar-term-icon">â„</div>
                                <div class="seal-text">
                                    <span class="highlight">${openingText.split('å¼€å¯')[0] || openingText}</span>${openingText.includes('å¼€å¯') ? 'å¼€å¯<br>' + openingText.split('å¼€å¯')[1] : ''}
                                </div>
                                <div class="seal-subtext">${openingSubtext}</div>
                            </div>
                            <div class="countdown-section">
                                <div class="countdown-label">â€” è·ç¦»å¼€å¯è¿˜æœ‰ â€”</div>
                                <div class="countdown-display">
                                    <div class="countdown-unit">
                                        <span class="countdown-value">${String(countdown.days).padStart(2, '0')}</span>
                                        <span class="countdown-name">å¤©</span>
                                    </div>
                                    <span class="countdown-separator">:</span>
                                    <div class="countdown-unit">
                                        <span class="countdown-value">${String(countdown.hours).padStart(2, '0')}</span>
                                        <span class="countdown-name">æ—¶</span>
                                    </div>
                                    <span class="countdown-separator">:</span>
                                    <div class="countdown-unit">
                                        <span class="countdown-value">${String(countdown.minutes).padStart(2, '0')}</span>
                                        <span class="countdown-name">åˆ†</span>
                                    </div>
                                    <span class="countdown-separator">:</span>
                                    <div class="countdown-unit">
                                        <span class="countdown-value">${String(countdown.seconds).padStart(2, '0')}</span>
                                        <span class="countdown-name">ç§’</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="overlay-footer">çµåºä¹¦é™¢ Â· æµæ˜Ÿèµ¶æœˆ</div>
                    </div>
                </body>
                </html>
            `);
        }

        // åˆå§‹åŒ–
        loadConfig();
    </script>
</body>
</html>
