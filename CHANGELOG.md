# Changelog / 更新日志

All notable changes to this project will be documented in this file.

本文件记录项目的所有重要更新。

## [1.4.0] - 2026-01-03

### Fixed / 修复
- **节气年份计算修正**
  - 修复子月(11月)和丑月(12月)节气日期年份显示错误的问题
  - `LunarYear.fromYear(YYYY).getJieQiJulianDays()` 从YYYY-1年12月大雪开始
  - 子月、丑月使用 `jieQiYear+1` 作为LunarYear参数

### Improved / 优化
- **农历卡片信息优化**
  - 完整展示节气月起止时间（精确到秒）
  - 智能年份显示：同年只显示起始年份，跨年时两端都显示
  - 时间格式：`2026/1/5 16:23:07 → 2/4 04:02:05`

- **倒计时文案优化**
  - 从「距本月结束还剩x天」改为「距XX月开始还有x天」
  - 下个月名称高亮显示（如：距**丑月**开始还有2天）
  - 非当前月份隐藏倒计时区域（时间范围已包含完整信息）

- **用户体验优化**
  - 移除冗余的日期范围显示，避免与时间范围重复
  - 信息展示更简洁清晰

---

## [1.3.2] - 2026-01-03

### Fixed / 修复
- **广告位默认启用状态**
  - 新建广告时默认不启用，避免误操作导致广告意外展示

### Added / 新增
- **广告图片缩略图功能**
  - 前端上传时自动生成压缩缩略图（300px宽度，WebP格式）
  - 后台预览使用缩略图，减少加载时间
  - 后端支持双文件上传（原图+缩略图）

- **广告加载超时策略**
  - API 请求超过 2 秒自动忽略
  - 广告图片加载超过 2 秒自动跳过
  - 确保页面不会因广告加载异常而卡顿

---

## [1.3.1] - 2026-01-03

### Fixed / 修复
- **登录状态持久化Bug**
  - 修复未勾选"保持登录状态"时关闭浏览器后仍保持登录的问题
  - 未勾选"保持登录"→ 使用 sessionStorage（浏览器关闭即清除）
  - 勾选"保持登录"→ 使用 localStorage（30天持久保存）
  - 所有页面（用户端+管理后台）统一支持双存储读取

### Changed / 变更
- **修改密码页面布局**
  - 调整为与登录页面一致的顶部对齐布局

---

## [1.3.0] - 2026-01-03

### Added / 新增
- **数九功能**
  - 从冬至开始显示"冬一九"至"冬九九"
  - 每九天标记一次，共81天
  - 与节气同时显示时使用滚动动画

### Fixed / 修复
- **节气日期修正**
  - 使用 lunar-javascript 专业库替换原有算法
  - 修复节气日期偏差问题（如大寒从错误的1月16日修正到1月20日）
  - 农历转换、节日计算全面升级

### Improved / 优化
- **多节日滚动显示**
  - 同一天有多个节气/节日时，使用向上滚动动画交替显示
  - 支持2-3个标签的平滑切换
  - 如：3月20日同时显示"春分"和"龙头节"

### Dependencies / 依赖
- 新增 lunar-javascript 农历计算库

---

## [1.2.0] - 2026-01-03

### Added / 新增
- **图片文件存储系统**
  - 广告图片改为上传到服务器文件系统，不再存储 Base64
  - 新增 `/api/admin/ads/upload-image` 图片上传接口
  - 新增 `/api/admin/ads/migrate-images` 旧数据迁移接口
  - 后台广告管理页面新增"迁移旧图片"按钮
  - Docker 新增 uploads 持久化卷

### Improved / 优化
- **URL 美化**
  - 隐藏 .html 扩展名，URL 更简洁美观
  - `/main.html` → `/main`
  - `/analysis.html` → `/analysis`
  - `/58xuzgnt/users.html` → `/58xuzgnt/users`
  - 旧链接仍兼容可访问

### Dependencies / 依赖
- 新增 multer 文件上传中间件

---

## [1.1.7] - 2026-01-03

### Fixed / 修复
- 广告管理页面"查看统计"功能报错问题
  - 修复 showStatsTab 函数在非点击事件调用时 event.target 未定义的bug

---

## [1.1.6] - 2026-01-03

### Optimized / 优化
- 广告管理页面加载速度大幅提升
  - 列表 API 不再返回完整图片数据（从 237KB 降到 < 1KB）
  - 图片预览改为异步加载
  - 页面框架秒开，图片后台加载

---

## [1.1.5] - 2026-01-03

### Fixed / 修复
- 月历中周末且为今天的日期，文字颜色与背景颜色靠色无法看清的问题

---

## [1.1.4] - 2026-01-02

### Optimized / 优化
- 数据库写入性能大幅提升（改为延迟保存策略）
  - 写操作不再立即保存文件，改为标记脏数据
  - 每5秒自动检查并保存变更
  - 进程退出时确保数据保存
  - 预计后台操作速度提升10-50倍

---

## [1.1.3] - 2026-01-02

### Fixed / 修复
- 登录页面按钮高度异常问题（移除错误的padding-top: 12vh）
- 登录页面布局调整为顶部对齐（padding-top从12vh改为2rem）

---

## [1.1.2] - 2026-01-02

### Fixed / 修复
- 全屏广告保存失败问题（增加请求体大小限制到10MB，支持大图片上传）

---

## [1.1.1] - 2026-01-02

### Fixed / 修复
- 登录页面加载画面内容错位问题（CSS align-items 修正）

---

## [1.1.0] - 2026-01-02

### Added / 新增
- 广告管理模块
  - 横版广告位（首页月历下方，支持点击跳转）
  - 全屏弹窗广告（3秒倒计时，可配置触发频率）
  - 后台广告管理页面（创建、编辑、删除、启用/禁用）
  - 广告统计功能（展示/点击/关闭次数，按用户/设备/日期维度）
  - 广告时效控制（开始时间、结束时间）
  - 触发频率配置（每次访问/每天一次/每次登录）

---

## [1.0.0] - 2026-01-02

### Added / 新增
- 用户登录/登出系统（支持30天长期登录）
- 农历日历展示（1900-2100年）
- 八字岁运页面（四柱八字、大运、流年、起运年龄）
- 命局分析页面
- 四季财官页面（春/夏/秋/冬运势）
- 流星赶月主页（月命批展示）
- 管理后台
  - 用户管理（创建、删除、重置密码、锁定）
  - 命批内容管理（支持批量导入）
  - 用户档案管理（八字信息）
  - 年度运势管理
- Docker一键部署支持
- 首次登录强制修改密码
- 访问日志记录（IP、设备、浏览器）

### Fixed / 修复
- 登录页面布局优化，避免手机键盘遮挡登录按钮
- 前端页面用户名显示问题
- 四季财官页面农历年份显示（干支格式）

---

## Version Format / 版本格式

- **主版本号**: 重大架构变更
- **次版本号**: 新增重要功能
- **补丁版本号**: Bug修复和小改进

格式: `[主版本号].[次版本号].[补丁版本号]`
